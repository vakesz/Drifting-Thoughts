# AGENTS.md

Guidelines for AI coding agents working in this repository.

**CORE PHILOSOPHY: Keep the codebase SIMPLE. Avoid over-engineering, unnecessary abstractions, and complex patterns.**

## Project Overview

**Drifting Thoughts** — iOS 26+ minimalist micro-journaling and poetry app.
Swift 6, SwiftUI, SwiftData, XcodeGen. No external dependencies, no backend, no tests.
Fully on-device, no accounts.

## LSP Diagnostics

Ignore all LSP errors during development. The Xcode project is generated by XcodeGen and LSP diagnostics are unreliable until `make generate` is run. Always validate correctness with `make build` instead.

## Build & Lint Commands

```bash
# Prerequisites
brew install xcodegen xcbeautify swiftlint

make build            # Generate Xcode project + build (Debug)
make build-release    # Generate Xcode project + build (Release)
make format-lint      # Auto-fix formatting + lint (run before EVERY commit)
make lint             # Lint only (no auto-fix)
make format           # Auto-fix only
make generate         # Regenerate .xcodeproj after project.yml changes
make clean            # Clean build artifacts
make clean-all        # Full clean including generated .xcodeproj and Info.plist
make open             # Open project in Xcode

# For VS Code/Neovim/Cursor LSP support
brew install xcode-build-server
make generate-sourcekit
```

There is **no test target**. No single-test command exists.

## Critical Rules

1. **Run `make format-lint` before every commit**
2. **No Combine** — `import Combine` is a lint ERROR. Use `async/await` and `@Observable`
3. **No print** — `print()`, `debugPrint()`, `NSLog()` are lint warnings. Use `os.Logger`
4. **No force_cast / force_try** — lint ERROR. `force_unwrapping` is a warning
5. **No external dependencies** — Apple frameworks only
6. **No repository/service layers** — direct SwiftData access via `@Query` and `ModelContext`
7. Never edit `.xcodeproj` directly — generated by XcodeGen from `project.yml`
8. Warnings are treated as errors (both GCC and Swift compiler settings)

## Swift 6 Patterns

| Use (Modern)       | Never Use (Legacy)                               |
|---------------------|--------------------------------------------------|
| `@Observable`       | `ObservableObject`, `@Published`                 |
| `@Bindable`         | `@ObservedObject`, `@StateObject`                |
| `async/await`       | `DispatchQueue`, completion handlers, Combine    |

Strict concurrency mode is `complete`.

## Architecture

```
View (@Query for reads) → ViewModel (@Observable) → ModelContext (writes)
```

- **Views**: `struct <Name>View: View` — own VM via `@State private var viewModel`
- **ViewModels**: `@MainActor @Observable final class <Name>ViewModel` — no stored singletons, access `AppSettings.shared` directly in methods
- **Models**: `@Model final class` (SwiftData)
- **Settings**: `AppSettings.shared` singleton — `@Observable` with manual `UserDefaults` via `didSet`, private init
- **No** repository layers, service layers, API clients, or caching abstractions

### Feature Module Structure

```
Features/<Name>/
├── <Name>View.swift
└── <Name>ViewModel.swift
```

### Directory Layout

```
App/              # Entry point, SwiftData container, root TabView, onboarding gate
Core/
├── DesignSystem/ # Colors, Layout, CardStyle, CardFontStyle
├── Models/       # Thought (@Model), CardThemeOverrides
└── Settings/     # AppSettings singleton
Features/         # Feature modules (View + ViewModel pairs)
Resources/        # Asset catalog (colors, app icon)
Supporting/       # Generated Info.plist (never edit)
```

## Code Style

### Imports

Sorted alphabetically (enforced by SwiftLint). Only import what's needed (`unused_import` analyzer rule active).

### Formatting

- **Line length**: 150 warning, 200 error (comments, URLs, function declarations, multiline strings exempt)
- **Trailing commas**: mandatory in multi-line collections
- **Vertical whitespace**: max 2 empty lines
- **MARK comments**: `// MARK: - Section Name` to separate view sections

### Attribute Placement (strictly enforced)

Same line as declaration: `@Environment`, `@State`, `@Binding`, `@Bindable`, `@Query`

```swift
@State private var viewModel = ComposeViewModel()
@Bindable private var settings = AppSettings.shared
```

Line above declaration: `@MainActor`, `@Observable`, `@Sendable`, `@ViewBuilder`, `@discardableResult`, `@available`, `@ObservationIgnored`

```swift
@MainActor
@Observable
final class ComposeViewModel { ... }
```

### Modifier Order

`override` > `isolation` > `acl` > `setterACL` > `dynamic` > `mutators` > `lazy` > `final` > `required` > `convenience` > `typeMethods` > `owned`

### Naming Conventions

- **Files**: `<Feature>View.swift`, `<Feature>ViewModel.swift`
- **Types**: PascalCase. Enums as namespaces use caseless enums (`enum DriftLayout { static let ... }`)
- **Properties/methods**: camelCase
- **UserDefaults keys**: `drift.<module>.<property>` (e.g., `drift.compose.autoKeyboard`)
- **Enums with options**: `enum Name: String, CaseIterable, Identifiable, Sendable`

### Type Patterns

```swift
@Model
final class Thought {
    var id: UUID
}

@MainActor
@Observable
final class ComposeViewModel {
    var title: String = ""
}

enum DriftLayout {                            // caseless enum namespace
    static let spacingXS: CGFloat = 4
}

extension Color {                             // colors from asset catalog
    static let brandAccent = Color("BrandAccent")
}
```

### Error Handling

- Use `try?` with optionals — never `try!`
- Use `guard let` for early returns on optionals
- Use `??` for safe fallback values
- Return optionals from functions that can fail
- No custom error types; errors are handled silently via optionals
- No throwing functions in the current codebase

### Design System

- **Layout**: `DriftLayout.spacingXS/SM/MD/LG/XL`, `DriftLayout.cornerRadiusSM/LG`, `DriftLayout.cardAspectRatio`
- **Limits**: `DriftLayout.maxCharacterCount` (500), `DriftLayout.maxTitleCount` (50), `DriftLayout.maxAuthorNameCount` (50)
- **Colors**: `Color.brandAccent`, `.backgroundPrimary`, `.textPrimary`, `.textSecondary`, `.textPlaceholder`, `.cardShadow` — all from asset catalog

## Theme System

- `CardStyle` — visual style enum (midnight/parchment/sunset) with MeshGradient backgrounds
- `CardFontStyle` — typography enum (serif/rounded/monospaced/classic)
- `CardThemeOverrides` — per-thought Codable customizations stored as JSON string in Thought model
- `CardThemeResolver` — static resolver merging style defaults + overrides into `ResolvedCardTheme`

## Git Conventions

- Imperative mood, sentence-case commit messages (e.g., "Add dark mode toggle")
- No conventional commit prefixes (`feat:`, `fix:`, etc.)
- Never add Co-Authored-By or attribution lines to commits
